#!/usr/bin/perl
use strict;
use warnings;

print "=======================================================================================================================================================================\n";

print "-----------------------------------------------------------------------------------------------------------------------------------------------------------------------\n";
print "Original data from Global Historical Climatology Network V2 (http://www.ncdc.noaa.gov/oa/climate/ghcn-daily/)\n";
print "This file generated by Climate Reanalyzer (http://cci-reanalyzer.org)\n";
print "Climate Change Institute; University of Maine; USA (http://climatechange.umaine.edu)\n";
print "KEY -- TMIN/TMAX/TMEAN = Temperature min/max/mean; PRCP = Precipitation; SNOW = Snowfall; SNWD = Snowdepth; WESD = Water Equiv. Snowdepth; WESN = Water Equiv. Snowfall\n";
print "UNITS -- TMIN/TMAX/TMEAN deg C; PRCP mm; SNOW/SNWD/WESD/WESN cm;\n";
print "=======================================================================================================================================================================\n";

my $file = 'test.dly';
my $id;
my $year;
my $prevYear = 0000;
my $month;
my $day;
my $element;
my $value;
my $mflag;
my $qflag;
my $sflag;
my $i;

open my $info, $file or die "Could not open $file: $!";

while (my $line = <$info>)  {
	$id = substr($line, 0, 11);
	$year = substr($line, 11, 4);
	$month = substr($line, 15, 2);
	$element = substr($line, 17, 4);

	if ($prevYear != $year)
		$day = 1;

	print "$id,$year $month $element";

	for ($i = 0; $i < 31; $i++) {
		$value = substr($line, $i * 8 + 21, 5);
		$mflag = substr($line, $i * 8 + 26, 1);
		$qflag = substr($line, $i * 8 + 27, 1);
		$sflag = substr($line, $i * 8 + 28, 1);

		print "$value $mflag $qflag $sflag";
	}
	print "\n";
}

close $info;
